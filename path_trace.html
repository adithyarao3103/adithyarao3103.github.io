<html>
<head>
    <title>Path Tracer</title>
    <meta charset="utf-8">
    <script src="https://cdn.plot.ly/plotly-2.12.1.min.js"></script>
</head>


<style>

    #controls{
        flex: 25%;
        padding: 30px;
    }


    #plot{
        flex: 75%;
    }
    
    #parent{
        width:95vw;
        height:95vh;
        display: flex;
    }
</style>

<body>

    <div id="parent">

    <div id="controls">
        <label for="qe">qe:</label><input type="text" id="qe" name="qe" value="0"><br>
        <label for="qm">qm:</label><input type="text" id="qm" name="qm" value="0"><br>
        <label for="vx">vx:</label><input type="text" id="vx" name="vx" value="0"><br>
        <label for="vy">vy:</label><input type="text" id="vy" name="vy" value="0"><br>
        <label for="vz">vz:</label><input type="text" id="vz" name="vz" value="0"><br>
        <label for="Ex">Ex:</label><input type="text" id="Ex" name="Ex" value="0"><br>
        <label for="Ey">Ey:</label><input type="text" id="Ey" name="Ey" value="0"><br>
        <label for="Ez">Ez:</label><input type="text" id="Ez" name="Ez" value="0"><br>
        <label for="Bx">Bx:</label><input type="text" id="Bx" name="Bx" value="0"><br>
        <label for="By">By:</label><input type="text" id="By" name="By" value="0"><br>
        <label for="Bz">Bz:</label><input type="text" id="Bz" name="Bz" value="0"><br>
        <label for="dt">dt:</label><input type="text" id="dt" name="dt" value="0"><br>
        <label for="time">time:</label><input type="text" id="time" name="time" value="0"><br>
        <button onclick="plot()">Trace Path</button><br>
        <button onclick="downconfig()">Download Configuration</button><br>
        <button onclick="downpath()">Download Path</button><br>
        <label for="file">Config File:</label><input type="file" id="file" name="file">
        
    </div><div id="plot"></div>

    </div>

</body>

<script>

    function getvalues(){
        qe = parseFloat(document.getElementById("qe").value);
        qm = parseFloat(document.getElementById("qm").value);
        v = [parseFloat(document.getElementById("vx").value), parseFloat(document.getElementById("vy").value), parseFloat(document.getElementById("vz").value)];
        B = [parseFloat(document.getElementById("Bx").value), parseFloat(document.getElementById("By").value), parseFloat(document.getElementById("Bz").value)];
        E = [parseFloat(document.getElementById("Ex").value), parseFloat(document.getElementById("Ey").value), parseFloat(document.getElementById("Ez").value)];
        dt = parseFloat(document.getElementById("dt").value);
        time = parseFloat(document.getElementById("time").value);
        r = [0,0,0];
F = [0,0,0];
rx = [];
ry = [];
rz = [];
    }

function plot(){
    getvalues();
track_path();
}


    function cross(v1, v2){
        v3 = [];
        v3[0] = (v1[1]*v2[2] - v1[2]*v2[1]);
        v3[1] = (v2[0]*v1[2] - v1[0]*v2[2]);
        v3[2] = (v1[0]*v2[1] - v1[1]*v2[0]);
        return(v3);
    }

    function plot_in_ly(x,y,z){

  Plotly.newPlot('plot', [{
  type: 'scatter3d',
  mode: 'lines',
  x: x,
  y: y,
  z: z,
  opacity: 1,
  line: {
    width: 6,
    color: 1,
    reversescale: false
  }
}],{
    autosize: true,
    automargin: true
}, {
    responsive: true
});
};

function track_path(){
    getpath();
    plot_in_ly(rx,ry,rz);
}

function getpath(){
    for(i = 0; i<=time; i+=dt){
        vB = cross(v, B);
        vE = cross(v, E);
        for(j = 0; j<3; j++){
            F[j] = qe*(E[j] + vB[j]) + qm*(B[j] - vE[j]);
            v[j] = v[j] + F[j]*dt;
            r[j] = r[j] + v[j]*dt;
        }
        rx.push(r[0]);
        ry.push(r[1]);
        rz.push(r[2]);
    }
}

function downconfig(){
    getvalues();
    arr = [qe].concat([qm], v, E, B, [dt], [time]);
    download("config.txt", arr);
}

function downpath(){
    getvalues();
    getpath();
    text = '';
    for(i = 0; i<rx.length; i++){
        text+= rx[i].toString().concat('\t',ry[i].toString(),'\t',rz[i].toString(), '\n');
    }
    download("path.txt", text);
}

function download(filename, text) {
  var element = document.createElement('a');
  element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
  element.setAttribute('download', filename);

  element.style.display = 'none';
  document.body.appendChild(element);

  element.click();

  document.body.removeChild(element);
}


document.getElementById('file').addEventListener('change', function() {
              
            var fr=new FileReader();
            fr.onload=function(){
                conf = fr.result;
                editvals(conf);
            }
              
            fr.readAsText(this.files[0]);
        })

function editvals(conf){
    conf = conf.split(',');
    document.getElementById("qe").value = parseFloat(conf[0]);
    document.getElementById("qm").value = parseFloat(conf[1]);
    document.getElementById("vx").value = parseFloat(conf[2]);
    document.getElementById("vy").value = parseFloat(conf[3]);
    document.getElementById("vz").value = parseFloat(conf[4]);
    document.getElementById("Ex").value = parseFloat(conf[5]);
    document.getElementById("Ey").value = parseFloat(conf[6]);
    document.getElementById("Ez").value = parseFloat(conf[7]);
    document.getElementById("Bx").value = parseFloat(conf[8]);
    document.getElementById("By").value = parseFloat(conf[9]);
    document.getElementById("Bz").value = parseFloat(conf[10]);
    document.getElementById("dt").value = parseFloat(conf[11]);
    document.getElementById("time").value = parseFloat(conf[12]);
}


</script>



</html>